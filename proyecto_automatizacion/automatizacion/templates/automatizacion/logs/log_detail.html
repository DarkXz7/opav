{% extends 'base.html' %}
{% load static %}

{% block title %}Detalle de Registro #{{ log.ProcesoID }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'automatizacion:index' %}">Inicio</a></li>
            <li class="breadcrumb-item"><a href="{% url 'automatizacion:view_logs' %}">Registros</a></li>
            <li class="breadcrumb-item active" aria-current="page">Registro #{{ log.ProcesoID }}</li>
        </ol>
    </nav>

    <h1 class="mb-4">
        <i class="fas fa-file-alt me-2"></i>
        Detalle de Registro #{{ log.ProcesoID }}
    </h1>

    <div class="row">
        <div class="col-lg-8">
            <!-- Información general -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5><i class="fas fa-info-circle me-2"></i>Información General</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-3 fw-bold">ID:</div>
                        <div class="col-md-9">{{ log.ProcesoID }}</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-3 fw-bold">Estado:</div>
                        <div class="col-md-9">
                            {% if 'Error' in log.Estado %}
                                <span class="badge bg-danger">{{ log.Estado }}</span>
                            {% elif 'Completado' in log.Estado %}
                                <span class="badge bg-success">{{ log.Estado }}</span>
                            {% elif 'Iniciando' in log.Estado %}
                                <span class="badge bg-info">{{ log.Estado }}</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ log.Estado }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-3 fw-bold">Fecha de Ejecución:</div>
                        <div class="col-md-9">{{ log.FechaEjecucion|date:"j F Y - H:i:s" }}</div>
                    </div>
                    {% if log.DuracionSegundos %}
                    <div class="row mb-3">
                        <div class="col-md-3 fw-bold">Duración:</div>
                        <div class="col-md-9">{{ log.DuracionSegundos }} segundos</div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Parámetros de Entrada -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5><i class="fas fa-cog me-2"></i>Parámetros de Entrada</h5>
                </div>
                <div class="card-body">
                    {% if params_json %}
                        {% if params_json|dictsort %}
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead>
                                        <tr>
                                            <th>Parámetro</th>
                                            <th>Valor</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for key, value in params_json.items %}
                                            <tr>
                                                <td class="fw-bold">{{ key }}</td>
                                                <td>
                                                    {% if value|stringformat:"s"|length > 100 %}
                                                        <div class="text-truncate" style="max-width: 500px;" 
                                                             data-bs-toggle="tooltip" data-bs-placement="top" 
                                                             title="{{ value }}">
                                                            {{ value }}
                                                        </div>
                                                    {% else %}
                                                        {{ value }}
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="alert alert-info mb-0">
                                <pre class="mb-0">{{ log.ParametrosEntrada|linebreaks }}</pre>
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="alert alert-light mb-0">
                            No se especificaron parámetros de entrada.
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Errores/Detalles -->
            {% if log.ErrorDetalle %}
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5>
                        {% if 'Error' in log.Estado %}
                            <i class="fas fa-exclamation-triangle me-2 text-danger"></i>Detalles del Error
                        {% else %}
                            <i class="fas fa-clipboard-list me-2"></i>Detalles Adicionales
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    <pre class="p-3 bg-light rounded mb-0" style="max-height: 300px; overflow-y: auto;">{{ log.ErrorDetalle }}</pre>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Barra lateral -->
        <div class="col-lg-4">
            <div class="card mb-4 border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-tools me-2"></i>Acciones</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'automatizacion:view_logs' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Volver a la lista
                        </a>
                        
                        {% if 'Error' in log.Estado %}
                        <button class="btn btn-outline-danger" onclick="alert('Esta funcionalidad estará disponible en una versión futura.')">
                            <i class="fas fa-bug me-2"></i>Analizar error
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Procesos relacionados -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5><i class="fas fa-project-diagram me-2"></i>Información de Contexto</h5>
                </div>
                <div class="card-body">
                    <p class="mb-3">
                        <i class="fas fa-database me-2 text-primary"></i>
                        <strong>Base de datos:</strong> SQL Server (LogsAutomatizacion)
                    </p>
                    <p class="mb-3">
                        <i class="fas fa-table me-2 text-primary"></i>
                        <strong>Tabla:</strong> ProcesoLog
                    </p>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Inicializar tooltips
        $('[data-bs-toggle="tooltip"]').tooltip();
    });
</script>
{% endblock %}
